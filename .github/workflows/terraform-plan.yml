name: Terraform Plan
on:
  pull_request:

jobs:
  terraform:
    name: Terraform Plan
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: read
    steps:
     - name: Clone repo
       uses: actions/checkout@v2
     - name: Formatting Check
       uses: Yellow-Box-Software/terraform-action@v2.5
       with:
         args: "fmt -check terraform"
     - name: Security scan
       uses: aquasecurity/tfsec-action@master
       with:
         soft_fail: true
         working_directory: terraform
     - name: Authenticate with Google Cloud
       uses: actions-hub/gcloud@master
       env:
         PROJECT_ID: ${{ secrets.GCP_PROJECT }}
         APPLICATION_CREDENTIALS: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}
       with:
         args: iam service-accounts keys create gcloud-service-key.json --iam-account github-deploy@${{ secrets.GCP_PROJECT }}.iam.gserviceaccount.com
     - name: Initialize Terraform
       uses: Yellow-Box-Software/terraform-action@v2.5
       env:
         GOOGLE_APPLICATION_CREDENTIALS: gcloud-service-key.json
       with:
         args: init -backend-config="bucket=${{ secrets.TF_BUCKET }}" terraform
     - name: Terraform Plan
       uses: Yellow-Box-Software/terraform-action@v2.5
       env:
         GOOGLE_APPLICATION_CREDENTIALS: gcloud-service-key.json
       with:
         args: >
           -chdir=terraform
           plan
           -var "gcp_project=${{ secrets.GCP_PROJECT }}"

